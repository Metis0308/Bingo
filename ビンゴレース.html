<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ“ãƒ‡ã‚ªã‚²ãƒ¼ãƒ ãƒ»ãƒ“ãƒ³ã‚´ãƒ¬ãƒ¼ã‚¹</title>
<!-- ï¼ˆCSSã¯å‰å›ã¨åŒã˜ãªã®ã§çœç•¥ã›ãšä½¿ã£ã¦OKï¼‰ -->
</head>
<body>
<!-- ï¼ˆHTMLæ§‹é€ ã¯å‰å›ã¨åŒã˜ï¼‰ -->

<script>
/* =====================
   OBS åˆ¤å®š
===================== */
const params = new URLSearchParams(location.search);
const isOBS = params.has("obs");
if (isOBS) document.body.classList.add("obs");

/* =====================
   ã‚«ãƒ†ã‚´ãƒªå®šç¾©
===================== */
let categories = {
  A: ["ãƒœã‚¹ã‚’æ’ƒç ´ã™ã‚‹", "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é€²ã‚ã‚‹"],
  B: ["æ•µã‚’10ä½“å€’ã™", "ã‚¢ã‚¤ãƒ†ãƒ 3å€‹å…¥æ‰‹"],
  C: ["NPCã¨ä¼šè©±ã™ã‚‹", "ã‚»ãƒ¼ãƒ–ã™ã‚‹"],
  D: []
};

const boardEl = document.getElementById("board");
const bingoText = document.getElementById("bingoText");
const editorEl = document.getElementById("editor");

/* =====================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
===================== */
const shuffle = arr => arr.slice().sort(() => Math.random() - 0.5);

const encode = obj =>
  btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
const decode = str =>
  JSON.parse(decodeURIComponent(escape(atob(str))));

function getAllTasks(excludeKey = null) {
  return Object.entries(categories)
    .filter(([k, v]) => k !== excludeKey && v.length)
    .flatMap(([_, v]) => v);
}

function getTaskFromCategory(key) {
  if (categories[key] && categories[key].length) {
    return shuffle(categories[key])[0];
  }
  const fallback = getAllTasks(key);
  return fallback.length ? shuffle(fallback)[0] : "FREE";
}

/* =====================
   ã‚¨ãƒ‡ã‚£ã‚¿ç”Ÿæˆ
===================== */
function buildEditor() {
  editorEl.innerHTML = "";
  for (const key in categories) {
    editorEl.insertAdjacentHTML(
      "beforeend",
      `<div>
        <h3>ã‚«ãƒ†ã‚´ãƒª ${key}</h3>
        <textarea id="cat_${key}">${categories[key].join("\n")}</textarea>
      </div>`
    );
  }
}

/* =====================
   ãƒ“ãƒ³ã‚´ç”Ÿæˆ
===================== */
function generateBoard(fromData = null) {
  const size = fromData?.size ?? Number(sizeSelect.value);
  boardEl.innerHTML = "";
  bingoText.textContent = "";
  boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

  const total = size * size;
  const center = Math.floor(total / 2);

  let tasks =
    fromData?.board ??
    (() => {
      let pool = shuffle(
        Object.keys(categories)
          .filter(k => k !== "A")
          .flatMap(k => categories[k])
      );
      while (pool.length < total) pool.push(...pool);
      return Array.from({ length: total }, (_, i) =>
        i === center ? getTaskFromCategory("A") : pool.pop()
      );
    })();

  tasks.forEach((text, i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.textContent = text;

    if (fromData?.checked?.includes(i)) {
      cell.classList.add("checked");
    }

    cell.onclick = () => {
      cell.classList.toggle("checked");
      checkBingo(size);
      updateURL();
    };

    boardEl.appendChild(cell);
  });

  sizeSelect.value = size;
  checkBingo(size);
  updateURL();
}

/* =====================
   ãƒ“ãƒ³ã‚´åˆ¤å®š
===================== */
function checkBingo(size) {
  const cells = [...document.querySelectorAll(".cell")];
  cells.forEach(c => c.classList.remove("bingo-line"));

  const lines = [];
  for (let r = 0; r < size; r++)
    lines.push([...Array(size)].map((_, c) => r * size + c));
  for (let c = 0; c < size; c++)
    lines.push([...Array(size)].map((_, r) => r * size + c));
  lines.push([...Array(size)].map((_, i) => i * size + i));
  lines.push([...Array(size)].map((_, i) => i * size + (size - 1 - i)));

  let bingo = false;
  lines.forEach(line => {
    if (line.every(i => cells[i].classList.contains("checked"))) {
      bingo = true;
      line.forEach(i => cells[i].classList.add("bingo-line"));
    }
  });

  bingoText.textContent = bingo ? "ğŸ‰ BINGO !!! ğŸ‰" : "";
}

/* =====================
   URL æ›´æ–°
===================== */
function updateURL() {
  const cells = [...document.querySelectorAll(".cell")];
  const data = {
    size: Number(sizeSelect.value),
    categories,
    board: cells.map(c => c.textContent),
    checked: cells
      .map((c, i) => (c.classList.contains("checked") ? i : null))
      .filter(v => v !== null)
  };

  const encoded = encode(data);
  history.replaceState(null, "", `?data=${encoded}${isOBS ? "&obs=1" : ""}`);
}

/* =====================
   ã‚¿ã‚¹ã‚¯åæ˜ 
===================== */
function applyTasks() {
  for (const key in categories) {
    categories[key] = document
      .getElementById(`cat_${key}`)
      .value.split("\n")
      .filter(Boolean);
  }
  generateBoard();
}

/* =====================
   åˆæœŸåŒ–ï¼ˆURLå¾©å…ƒï¼‰
===================== */
buildEditor();

if (params.has("data")) {
  const restored = decode(params.get("data"));
  categories = restored.categories;
  buildEditor();
  generateBoard(restored);
} else {
  generateBoard();
}
</script>

</body>
</html>
