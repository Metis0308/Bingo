<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ“ãƒ‡ã‚ªã‚²ãƒ¼ãƒ ãƒ»ãƒ“ãƒ³ã‚´ãƒ¬ãƒ¼ã‚¹</title>

<style>
:root {
  --btn-grad: linear-gradient(135deg, #4facfe, #00f2fe);
  --btn-glow: 0 0 12px #4facfe;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #2b2b40, #111);
  color: #fff;
  padding: 20px;
}

h1 {
  text-shadow: 0 0 10px #6cf;
}

/* ===== ãƒœã‚¿ãƒ³ ===== */
button {
  background: var(--btn-grad);
  border: none;
  border-radius: 20px;
  padding: 8px 18px;
  color: #000;
  font-weight: bold;
  cursor: pointer;
  box-shadow: var(--btn-glow);
  transition: 0.2s;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 20px #6cf;
}

button:active {
  transform: translateY(1px);
  box-shadow: 0 0 6px #6cf inset;
}

select {
  background: #111;
  color: #fff;
  border: 1px solid #555;
  padding: 6px;
}

/* ===== ãƒ“ãƒ³ã‚´ç›¤ ===== */
.board {
  display: grid;
  gap: 8px;
  max-width: 650px;
  margin-top: 15px;
}

.cell {
  background: linear-gradient(145deg, #ffffff25, #00000055);
  border: 2px solid #888;
  border-radius: 12px;
  padding: 10px;
  min-height: 85px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: 0.2s;
  box-shadow: inset 0 0 10px #000;
}

.cell.checked {
  background: linear-gradient(145deg, #3cff6a, #1f8f3f);
  color: #000;
  box-shadow: 0 0 14px #3cff6a;
}

.cell.bingo-line {
  border-color: gold;
  box-shadow: 0 0 20px gold;
}

.bingo {
  font-size: 26px;
  margin-top: 10px;
  color: gold;
  text-shadow: 0 0 12px gold;
}

/* ===== ã‚¨ãƒ‡ã‚£ã‚¿ ===== */
.editor {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
  margin-top: 25px;
}

.editor textarea {
  width: 100%;
  height: 140px;
  background: #0d0d14;
  color: #fff;
  border: 1px solid #555;
  border-radius: 8px;
  padding: 8px;
}

.editor-controls {
  margin-top: 10px;
}

/* ===== OBS ===== */
body.obs {
  background: transparent;
}

body.obs h1,
body.obs .controls,
body.obs .editor,
body.obs .editor-controls {
  display: none;
}

body.obs .board {
  margin-top: 0;
  max-width: 100%;
}
</style>
</head>

<body>

<h1>ELDEN RING NIGHTREIGN BINGO</h1>

<div class="controls">
  ã‚µã‚¤ã‚º:
  <select id="sizeSelect">
    <option value="3">3Ã—3</option>
    <option value="5" selected>5Ã—5</option>
  </select>
  <button onclick="generateBoard()">ç”Ÿæˆ</button>
</div>

<div id="board" class="board"></div>
<div id="bingoText" class="bingo"></div>

<h2>ğŸ›  ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒª</h2>
<p>â€» ç©ºã‚«ãƒ†ã‚´ãƒªã¯ä»–ã‚«ãƒ†ã‚´ãƒª or FREE ã‚’è‡ªå‹•å‚ç…§</p>

<!-- â˜… ã“ã“ãŒç„¡ã„ã¨å‰å›ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ -->
<div class="editor" id="editor"></div>

<div class="editor-controls">
  <button onclick="addCategory()">ï¼‹ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
  <button onclick="applyTasks()">ã‚¿ã‚¹ã‚¯åæ˜ ï¼ˆå†ç”Ÿæˆï¼‰</button>
</div>


<script>
/* =====================
   OBS åˆ¤å®š
===================== */
const params = new URLSearchParams(location.search);
const isOBS = params.has("obs");
if (isOBS) document.body.classList.add("obs");

/* =====================
   ã‚«ãƒ†ã‚´ãƒªå®šç¾©
===================== */
let categories = {
  Center: ["è¿½è·¡è€…ã‚’ä½¿ç”¨ã™ã‚‹", "å®ˆè­·è€…ã‚’ä½¿ç”¨ã™ã‚‹","ãƒ¬ãƒ‡ã‚£ã‚’ä½¿ç”¨ã™ã‚‹","éš è€…ã‚’ä½¿ç”¨ã™ã‚‹", "é‰„ã®ç›®ã‚’ä½¿ç”¨ã™ã‚‹","ç„¡é ¼æ¼¢ã‚’ä½¿ç”¨ã™ã‚‹","åŸ·è¡Œè€…ã‚’ä½¿ç”¨ã™ã‚‹", "å¾©è®è€…ã‚’ä½¿ç”¨ã™ã‚‹","å­¦è€…ã‚’ä½¿ç”¨ã™ã‚‹","è‘¬å„€å±‹ã‚’ä½¿ç”¨ã™ã‚‹"],
  B: ["æ•µã‚’30ä½“ä»¥ä¸Šå€’ã™","ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒœã‚¹ã‚’3ä½“ä»¥ä¸Šå€’ã™", "ä¸­å¤®ç ¦ã®ãƒœã‚¹ã‚’å€’ã™","éœŠé·¹ã®æ­¢ã¾ã‚Šæœ¨ã‚’ä½¿ç”¨ã™ã‚‹","éœŠè„ˆã‚’3ã‹æ‰€ä½¿ç”¨ã™ã‚‹"],
  C: ["æ•™ä¼šã‚’1ã‹æ‰€è¨ªã‚Œã‚‹", "é­”è¡“å¸«å¡”ã‚’1ã‹æ‰€é–‹æ”¾ã™ã‚‹", "å°ç‰¢2ã‹æ‰€ã‚‚ã—ãã¯ç½åŸŸã‚’æ”»ç•¥ã™ã‚‹"],
  D: ["ã‚¹ã‚«ãƒ©ãƒ™ã‚’1ä½“å€’ã™","åŸ‹ã‚‚ã‚ŒãŸå®ã‚’1å€‹é–‹ã‘ã‚‹","éºè·¡ã‚’1ã‹æ‰€æ”»ç•¥ã™ã‚‹"]}

const boardEl = document.getElementById("board");
const bingoText = document.getElementById("bingoText");
const editorEl = document.getElementById("editor");
const sizeSelect = document.getElementById("sizeSelect");
let centerCategoryKey = "Center";

/* =====================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
===================== */
const shuffle = arr => arr.slice().sort(() => Math.random() - 0.5);

const encode = obj =>
  btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
const decode = str =>
  JSON.parse(decodeURIComponent(escape(atob(str))));

function getAllTasks(excludeKey = null) {
  return Object.entries(categories)
    .filter(([k, v]) => k !== excludeKey && v.length)
    .flatMap(([_, v]) => v);
}

function getTaskFromCategory(key) {
  if (categories[key] && categories[key].length) {
    return shuffle(categories[key])[0];
  }
  const fallback = getAllTasks(key);
  return fallback.length ? shuffle(fallback)[0] : "FREE";
}

/* =====================
   ã‚¨ãƒ‡ã‚£ã‚¿ç”Ÿæˆï¼ˆnullã‚¬ãƒ¼ãƒ‰ï¼‰
===================== */
function buildEditor() {
  if (!editorEl) return;
  editorEl.innerHTML = "";

  Object.keys(categories).forEach(key => {
    const box = document.createElement("div");

    box.innerHTML = `
      <h3>
        ${key}
        ${key === centerCategoryKey ? "â­(ä¸­å¤®)" : ""}
      </h3>
      <textarea id="cat_${key}">${categories[key].join("\n")}</textarea>
    `;

    editorEl.appendChild(box);
  });
}


/* =====================
   ãƒ“ãƒ³ã‚´ç”Ÿæˆ
===================== */
function generateBoard(fromData = null) {
  const size = fromData?.size ?? Number(sizeSelect.value);
  boardEl.innerHTML = "";
  bingoText.textContent = "";
  boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

  const total = size * size;
  const center = Math.floor(total / 2);

  const result = new Array(total).fill(null);

  // ä¸­å¤®ãƒã‚¹ï¼ˆã‚«ãƒ†ã‚´ãƒªAå„ªå…ˆï¼‰
  const centerTask = getTaskFromCategory("A");
  result[center] = centerTask;

  // é‡è¤‡æ’é™¤æ¸ˆã¿ãƒ—ãƒ¼ãƒ«
  let pool = buildUniqueTaskPool([centerTask]);

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  pool = pool.sort(() => Math.random() - 0.5);

  for (let i = 0; i < total; i++) {
    if (i === center) continue;

    if (pool.length > 0) {
      result[i] = pool.shift();
    } else {
      result[i] = "FREE";
    }
  }

  result.forEach((task, i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.textContent = task;

    if (fromData?.checked?.includes(i)) {
      cell.classList.add("checked");
    }

    cell.onclick = () => {
      cell.classList.toggle("checked");
      checkBingo(size);
      updateURL();
    };

    boardEl.appendChild(cell);
  });

  checkBingo(size);
  updateURL();
}
function generateBoard(fromData = null) {
  const size = fromData?.size ?? Number(sizeSelect.value);
  boardEl.innerHTML = "";
  bingoText.textContent = "";
  boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

  const total = size * size;
  const center = Math.floor(total / 2);

  const result = new Array(total).fill(null);

  // ä¸­å¤®ãƒã‚¹ï¼ˆã‚«ãƒ†ã‚´ãƒªAå„ªå…ˆï¼‰
  const centerTask = getTaskFromCategory("A");
  result[center] = centerTask;

  // é‡è¤‡æ’é™¤æ¸ˆã¿ãƒ—ãƒ¼ãƒ«
  let pool = buildUniqueTaskPool([centerTask]);

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  pool = pool.sort(() => Math.random() - 0.5);

  for (let i = 0; i < total; i++) {
    if (i === center) continue;

    if (pool.length > 0) {
      result[i] = pool.shift();
    } else {
      result[i] = "FREE";
    }
  }

  result.forEach((task, i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.textContent = task;

    if (fromData?.checked?.includes(i)) {
      cell.classList.add("checked");
    }

    cell.onclick = () => {
      cell.classList.toggle("checked");
      checkBingo(size);
      updateURL();
    };

    boardEl.appendChild(cell);
  });

  checkBingo(size);
  updateURL();
}
function buildUniqueTaskPool(exclude = []) {
  const set = new Set();

  Object.entries(categories).forEach(([key, list]) => {
    if (key === "A") return; // â† é‡è¦ï¼šAã¯é™¤å¤–

    list.forEach(task => {
      if (!exclude.includes(task)) {
        set.add(task);
      }
    });
  });

  return Array.from(set);
}


/* =====================
   ãƒ“ãƒ³ã‚´åˆ¤å®š
===================== */
function checkBingo(size) {
  const cells = [...document.querySelectorAll(".cell")];
  cells.forEach(c => c.classList.remove("bingo-line"));

  const lines = [];
  for (let r = 0; r < size; r++)
    lines.push([...Array(size)].map((_, c) => r * size + c));
  for (let c = 0; c < size; c++)
    lines.push([...Array(size)].map((_, r) => r * size + c));
  lines.push([...Array(size)].map((_, i) => i * size + i));
  lines.push([...Array(size)].map((_, i) => i * size + (size - 1 - i)));

  let bingo = false;
  lines.forEach(line => {
    if (line.every(i => cells[i].classList.contains("checked"))) {
      bingo = true;
      line.forEach(i => cells[i].classList.add("bingo-line"));
    }
  });

  bingoText.textContent = bingo ? "ğŸ‰ BINGO !!! ğŸ‰" : "";
}

/* =====================
   URL æ›´æ–°
===================== */
function updateURL() {
  const cells = [...document.querySelectorAll(".cell")];
  const data = {
    size: Number(sizeSelect.value),
    categories,
    board: cells.map(c => c.textContent),
    checked: cells
      .map((c, i) => (c.classList.contains("checked") ? i : null))
      .filter(v => v !== null)
  };

  const encoded = encode(data);
  history.replaceState(
    null,
    "",
    `?data=${encoded}${isOBS ? "&obs=1" : ""}`
  );
}

/* =====================
   ã‚¿ã‚¹ã‚¯åæ˜ 
===================== */
function applyTasks() {
  Object.keys(categories).forEach(key => {
    const ta = document.getElementById(`cat_${key}`);
    if (!ta) return;
    categories[key] = ta.value.split("\n").filter(Boolean);
  });
  generateBoard();
}

/* =====================
   åˆæœŸåŒ–
===================== */
buildEditor();

if (params.has("data")) {
  try {
    const restored = decode(params.get("data"));
    categories = restored.categories;
    buildEditor();
    generateBoard(restored);
  } catch {
    generateBoard();
  }
} else {
  generateBoard();
}

function addCategory() {
  let name = prompt("ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  if (!name) return;

  name = name.trim();

  if (categories[name]) {
    alert("åŒåã‚«ãƒ†ã‚´ãƒªãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™");
    return;
  }

  categories[name] = [];
  buildEditor();
  updateURL();
}



  
</script>

</body>
</html>




